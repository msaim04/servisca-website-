name: Deploy Frontend (Servisca Website)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-frontend:
    name: Deploy Servisca Website
    runs-on: ubuntu-latest
    environment: production  # Optional: For manual approval

    steps:
      # ---------------------------------------------------
      # 1. Checkout repository
      # ---------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # 2. Setup Node.js
      # ---------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.10.0
          cache: "npm"

      # ---------------------------------------------------
      # 3. Install dependencies
      # ---------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # ---------------------------------------------------
      # 4. Lint code
      # ---------------------------------------------------
      - name: Lint code
        run: npm run lint

      # ---------------------------------------------------
      # 5. Run unit tests
      # ---------------------------------------------------
      - name: Run unit tests
        run: npm test --if-present

      # ---------------------------------------------------
      # 6. Build Next.js project
      # ---------------------------------------------------
      - name: Build Next.js project
        run: npm run build

      # ---------------------------------------------------
      # 7. Debug: Check workspace and files
      # ---------------------------------------------------
      - name: Debug - Check workspace and files
        run: |
          echo "Current directory: $(pwd)"
          echo "Listing all files:"
          ls -la
          echo "Checking .next directory:"
          if [ -d .next ] && [ "$(ls -A .next)" ]; then
            echo ".next exists and has contents"
            ls -la .next | head -10
          else
            echo ".next is missing or empty - build may have failed"
            exit 1
          fi

      # ---------------------------------------------------
      # 8. Validate source files exist
      # ---------------------------------------------------
      - name: Validate source files
        run: |
          REQUIRED_FILES=".next public package.json package-lock.json"
          for file in $REQUIRED_FILES; do
            if [ ! -e "$file" ]; then
              echo "Error: Required file/directory '$file' is missing!"
              exit 1
            fi
          done
          echo "All required source files exist."

      # ---------------------------------------------------
      # 9. Backup current version on server
      # ---------------------------------------------------
      - name: Backup current version
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            if [ -d /var/www/servisca-website- ]; then
              echo "Backing up current version to /var/www/servisca-website-backup..."
              rm -rf /var/www/servisca-website-backup
              mv /var/www/servisca-website- /var/www/servisca-website-backup
            else
              echo "No existing version to backup."
            fi

      # ---------------------------------------------------
      # 9.5. Check server disk space
      # ---------------------------------------------------
      - name: Check server disk space
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "Checking disk space on server..."
            DISK_USAGE=$(df /var/www | tail -1 | awk '{print $5}' | sed 's/%//')
            echo "Disk usage: $DISK_USAGE%"
            if [ "$DISK_USAGE" -gt 90 ]; then
              echo "Error: Disk usage is over 90% ($DISK_USAGE%). Free up space before deploying."
              exit 1
            else
              echo "Disk space is sufficient."
            fi

      # ---------------------------------------------------
      # 10. Upload build to server (using rsync directly)
      # ---------------------------------------------------
      - name: Upload build to server
        run: |
          echo "Setting up SSH key..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          
          echo "Uploading files with rsync..."
          rsync -avz --delete \
            .next/ \
            public/ \
            package.json \
            package-lock.json \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/var/www/servisca-website-/
          
          echo "Upload complete. Cleaning up SSH key..."
          rm ~/.ssh/id_rsa

      # ---------------------------------------------------
      # 11. Install dependencies on server
      # ---------------------------------------------------
      - name: Install dependencies on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /var/www/servisca-website-
            echo "Installing production dependencies..."
            npm ci --omit=dev

      # ---------------------------------------------------
      # 12. Start frontend with PM2
      # ---------------------------------------------------
      - name: Start frontend with PM2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /var/www/servisca-website-
            echo "Starting app with PM2..."
            pm2 delete servisca_frontend || true
            pm2 start npm --name "servisca_frontend" -- run start
            pm2 save

      # ---------------------------------------------------
      # 13. Reload Nginx
      # ---------------------------------------------------
      - name: Reload Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "Reloading Nginx..."
            sudo systemctl reload nginx

      # ---------------------------------------------------
      # 14. Wait for app to stabilize
      # ---------------------------------------------------
      - name: Wait for app to stabilize
        run: sleep 5

      # ---------------------------------------------------
      # 15. Health check website
      # ---------------------------------------------------
      - name: Health check website
        id: health
        run: |
          echo "Performing health check on ${{ secrets.FRONTEND_URL }}..."
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" ${{ secrets.FRONTEND_URL }} || echo "000")
          echo "HTTP Status: $STATUS"
          if [ "$STATUS" != "200" ]; then
            echo "Health check failed (status: $STATUS). Triggering rollback."
            echo "failed=true" >> $GITHUB_ENV
            exit 1
          else
            echo "Health check passed."
            echo "failed=false" >> $GITHUB_ENV
          fi
        continue-on-error: true

      # ---------------------------------------------------
      # 16. Rollback if health check failed
      # ---------------------------------------------------
      - name: Rollback to previous version
        if: env.failed == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "Rolling back to previous version..."
            rm -rf /var/www/servisca-website-
            mv /var/www/servisca-website-backup /var/www/servisca-website-
            cd /var/www/servisca-website-
            pm2 delete servisca_frontend || true
            pm2 start npm --name "servisca_frontend" -- run start
            pm2 save
            sudo systemctl reload nginx
            echo "Rollback complete."
