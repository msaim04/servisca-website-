name: Deploy Frontend (Servisca Website)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-frontend:
    name: Deploy Servisca Website
    runs-on: ubuntu-latest

    steps:

      # ---------------------------------------------------
      # 1. Checkout repository
      # ---------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # 2. Setup Node.js
      # ---------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.10.0
          cache: "npm"

      # ---------------------------------------------------
      # 3. Install dependencies
      # ---------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # ---------------------------------------------------
      # 4. Lint code
      # ---------------------------------------------------
      - name: Lint code
        run: npm run lint

      # ---------------------------------------------------
      # 5. Run unit tests
      # ---------------------------------------------------
      - name: Run unit tests
        run: npm test --if-present

      # ---------------------------------------------------
      # 6. Build Next.js project
      # ---------------------------------------------------
      - name: Build Next.js project
        run: npm run build

      # ---------------------------------------------------
      # 7. Backup current version (just rename)
      # ---------------------------------------------------
      - name: Backup current version
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            if [ -d /var/www/servisca-website ]; then
              rm -rf /var/www/servisca-website-prev
              mv /var/www/servisca-website /var/www/servisca-website-prev
            fi

      # ---------------------------------------------------
      # 8. Upload build folder
      # ---------------------------------------------------
      - name: Upload project source
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "out/*"
          target: "/var/www/servisca-website-/"
          overwrite: true

      # ---------------------------------------------------
      # 9. Install dependencies on server
      # ---------------------------------------------------
      - name: Install dependencies on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /var/www/servisca-website
            npm ci --omit=dev

      # ---------------------------------------------------
      # 10. Start frontend with PM2
      # ---------------------------------------------------
      - name: Start frontend with PM2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /var/www/servisca-website
            pm2 delete servisca_frontend || true
            pm2 start npm --name "servisca_frontend" -- run start
            pm2 save

      # ---------------------------------------------------
      # 11. Reload Nginx
      # ---------------------------------------------------
      - name: Reload Nginx
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sudo systemctl reload nginx

      # ---------------------------------------------------
      # 12. Wait for app to stabilize
      # ---------------------------------------------------
      - name: Wait for app to stabilize
        run: sleep 5

      # ---------------------------------------------------
      # 13. Health check website
      # ---------------------------------------------------
      - name: Health check website
        id: health
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" ${{ secrets.FRONTEND_URL }} || true)
          echo "STATUS=$STATUS"
          if [ "$STATUS" != "200" ]; then
            echo "failed=true" >> $GITHUB_ENV
            exit 1
          else
            echo "failed=false" >> $GITHUB_ENV
          fi
        continue-on-error: true

      # ---------------------------------------------------
      # 14. Rollback if failed
      # ---------------------------------------------------
      - name: Rollback to previous version
        if: env.failed == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            rm -rf /var/www/servisca-website
            mv /var/www/servisca-website-prev /var/www/servisca-website
            cd /var/www/servisca-website
            pm2 delete servisca_frontend || true
            pm2 start npm --name "servisca_frontend" -- run start
            pm2 save
            sudo systemctl reload nginx
