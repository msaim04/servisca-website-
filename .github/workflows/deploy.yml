name: Deploy Frontend (Servisca Website)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-frontend:
    name: Deploy Servisca Website
    runs-on: ubuntu-latest

    steps:

      # ---------------------------------------------------
      # 1. Checkout repository
      # ---------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # 2. Setup Node.js + NPM cache
      # ---------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # ---------------------------------------------------
      # 3. Install dependencies
      # ---------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # ---------------------------------------------------
      # 4. Lint
      # ---------------------------------------------------
      - name: Lint code
        run: npm run lint

      # ---------------------------------------------------
      # 5. Run tests (optional)
      # ---------------------------------------------------
      - name: Run tests
        run: npm test --if-present

      # ---------------------------------------------------
      # 6. Build Next.js
      # ---------------------------------------------------
      - name: Build project
        run: npm run build

      # ---------------------------------------------------
      # 7. Backup current version on server
      # ---------------------------------------------------
      - name: Backup current version (rename)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            if [ -d /var/www/servisca-website ]; then
              rm -rf /var/www/servisca-website-prev
              mv /var/www/servisca-website /var/www/servisca-website-prev
            fi
            mkdir -p /var/www/servisca-website

      # ---------------------------------------------------
      # 8. Upload build output
      # ---------------------------------------------------
      - name: Upload build to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          target: "/var/www/servisca-website"
          strip_components: 0
          source: |
            .next
            public
            package.json
            package-lock.json
            next.config.js


      # ---------------------------------------------------
      # 9. Install production dependencies on server
      # ---------------------------------------------------
      - name: Install server dependencies
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /var/www/servisca-website
            npm ci --omit=dev

      # ---------------------------------------------------
      # 10. Restart PM2
      # ---------------------------------------------------
      - name: Restart PM2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /var/www/servisca-website
            pm2 delete servisca_frontend || true
            pm2 start npm --name servisca_frontend -- run start
            pm2 save

      # ---------------------------------------------------
      # 11. Reload Nginx
      # ---------------------------------------------------
      - name: Reload Nginx
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: sudo systemctl reload nginx

      # ---------------------------------------------------
      # 12. Health check
      # ---------------------------------------------------
      - name: Health check website
        id: health
        run: |
          sleep 6
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" ${{ secrets.FRONTEND_URL }} || true)
          echo "STATUS=$STATUS"
          echo "failed=$([ "$STATUS" != "200" ] && echo true || echo false)" >> $GITHUB_ENV
        continue-on-error: true

      # ---------------------------------------------------
      # 13. Rollback if failed
      # ---------------------------------------------------
      - name: Rollback to previous version
        if: env.failed == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            rm -rf /var/www/servisca-website
            mv /var/www/servisca-website-prev /var/www/servisca-website
            cd /var/www/servisca-website
            pm2 delete servisca_frontend || true
            pm2 start npm --name servisca_frontend -- run start
            pm2 save
            sudo systemctl reload nginx
